/*
	Created by: Joseph Tveter
	email: josephtveter@gmail.com
	git: https://github.com/josephtveter/FN_Ajax
	GPL: Use and edit and Enjoy.  This is an example of my work.

	Purpose:
		This library is to give Promise Object support.  If your site needs to support promises but also needs to support IE, so you can not use window.Promise.  Jquery is nice, but it is heavy.  FN_Deferred weighs in about 3kb.  FN_Deferred is a great stable micro library. Give it a whirl.   
*/
!function(e){function t(e,t){for(var n=e.length,s=-1;++s<n&&t.call(e,e[s],s)!==!1;);return e}var n=function(){return"undefined"!=typeof setImmediate?setImmediate:"undefined"!=typeof process?process.nextTick:function(e){e&&setTimeout(e,0)}}(),s=function(e,t,r,a){var i=this;this.id=a||null,r=isNaN(r)||r===!0?0:r;var o=[],u=[],f=[];this.state=s.state.PENDING,this.value=null,e&&o.push(e),t&&f.push(t),this.reject=function(e){return i.state>s.state.PENDING?i:(i.state=s.state.FAILURE,d.apply(this,arguments),i)},this.resolve=function(e){return i.state>s.state.PENDING?i:(i.state=s.state.SUCCESS,d.apply(this,arguments),i)},this.promise=function(e){return i},this.always=function(e){return"function"==typeof e&&(i.state!==s.state.PENDING&&n(e.apply(this,i.value)),u.push(e)),i},this.done=function(e){return"function"==typeof e&&(i.state===s.state.SUCCESS&&n(e.apply(this,i.value)),o.push(e)),i},this.then=function(e,t){return i.done(e),i.fail(t),i},i.fail=function(e){return"function"==typeof e&&(i.state===s.state.FAILURE&&n(e.apply(this,i.value)),f.push(e)),i},this["catch"]=this.fail,this.isRejected=function(){return i.state===s.state.FAILURE},this.isResolved=function(){return i.state===s.state.SUCCESS},this.status=function(){var e=i.state,t=s.status[e];return t};var c=!0,d=function(e){if(i.state===s.state.PENDING)return i;i.value=arguments;var t=function(e,t,n){var r=0;try{var a=e.length;for(r=0;a>r;r++)e[r].apply(t,n)}catch(o){console.warn("Deferred callback Failed for state - "+i.status()+": "+o.message),c&&(c=!1,i.state=s.state.FAILURE,d({errorType:"deferred_callback_error",error:o,message:"An Error occured in this function: "+e[r].toString()}))}};return i.state===s.state.SUCCESS?t(o,this,arguments):i.state===s.state.FAILURE&&t(f,this,arguments),t(u,this,arguments),i};r&&window.setTimeout(function(){i.state===s.state.PENDING&&i.reject({errorType:"deferred_timed_out"})},r)};s.state={PENDING:0,FAILURE:1,SUCCESS:2},s.status=["pending","rejected","resolved"],s.when=function(){var e,n=0,r=new s,a=[].slice.call(arguments),i=null;return a[0]instanceof Array&&(a=a[0]),"function"==typeof arguments[1]&&(i=arguments[1]),e=a.length,0===e?r.resolve(null):t(a,function(t){t.then(function(){++n!==e||r.isResolved()||(r.resolve.apply(this,a),i&&i.apply(this,a))},function(){r.isResolved()||(r.reject.apply(this,a),i&&i.apply(this,a))})}),r},"undefined"!=typeof exports?module.exports=s:"function"==typeof define&&define.amd?define("Deferred",[],function(){return s}):"function"==typeof define?define("Deferred",s):window.Deferred=s}(this),function(e){function t(e,t){return new n(e,t)}var n=function(e,n){var s=this;e=e||{},n=n||0;var r=new Deferred,a=new XMLHttpRequest,i=2e4,o="GET",u=5,f="application/x-www-form-urlencoded; charset=UTF-8",c="json",d="------multipartformboundary"+(new Date).getTime(),p=e.contentType&&-1!==e.contentType.indexOf("multipart")?!0:!1,l=e.requestType,h=e.url,y=e.maxRetry||e.retry||u,m=(e.dataType||c,"GET"===e.method||"POST"===e.method?e.method:o),v=e.async||!0,T="";if(e.data){if("object"==typeof e.data)for(var g in e.data){var w=g+"="+encodeURIComponent(e.data[g]);"GET"===m&&-1!==h.indexOf(w)||(T.length>0&&(T+="&"),T+=w)}else"string"==typeof e.data&&(T=e.data);T.length>0&&"GET"===m&&(h+=-1===h.indexOf("?")?"?":"&",h+=T)}var E=navigator.userAgent.toString(),x=-1!==E.indexOf("Trident")?!0:!1;if(x===!1&&(a.timeout=e.timeout?e.timeout:i),a.open(m,h,v),this.contentType=e.contentType?e.contentType:f,p&&(this.contentType+="; boundary="+d),(!e.headers||e.headers&&!e.headers["Content-Type"])&&a.setRequestHeader("Content-Type",this.contentType),e.headers){if("object"==typeof e.headers)for(var g in e.headers)a.setRequestHeader(g,e.headers[g]);e.headers["X-Requested-With"]||a.setRequestHeader("X-Requested-With","XMLHttpRequest")}this.statusCode=null,this.responseObj={};var S=e.responseType||e.dataType||c,N=!1;this.done=r.done,this.success=this.done,this.fail=r.fail,this.always=r.always,e.error&&this.fail(e.error),e.success&&this.done(e.success),e.complete&&this.always(e.complete);var R=function(e,t){var n=I(),a=e;switch(s.statusCode=t.status,S){case"json":try{"string"==typeof e?(e=e.replace(/(\r\n|\n|\r)/gm,""),a=JSON.parse(e)):a=e}catch(i){var o="string"==typeof i?i:JSON.stringify(i);console.warn(o+" ---- fnAjax JSON.parse Fail: "+e),a=e}break;default:a=e}r.resolve(a,t,n,l||h)},j=function(e,t){N||(s.statusCode=a.status,N=!0,r.reject(t,l||h,a))},I=function(){for(var e={},t=a.getAllResponseHeaders().split("\n"),n=t.length,s=0;n>s;s++)if(t[s].length>0){var r=t[s].indexOf(":");if(r>0){var i=t[s].substring(0,r),o=t[s].substring(r+1).trim();e[i]=o}}return e};if(a.onreadystatechange=function(){if(4===a.readyState&&200===a.status)s.responseObj={url:h,status:a.status,responseText:a.responseText,requestType:l},R(a.responseText,a);else if(200!==a.status&&0!==a.status){var t=null;switch(a.status){case 404:t="NotFound";break;default:t="unknown"}j({},{errorType:t,status:a.status,requestType:l,requestParams:e})}},a.ontimeout=function(s){y>=n?(n++,e.timeout=a.timeout+1e3*n,t(e,n).fail(function(e){j(s,{errorType:"xhrTimeout"})}).done(function(e){R(e,a)})):j(s,{errorType:"xhrTimeout"})},a.onabort=function(e){j(e,{errorType:"xhrAbort"})},a.onerror=function(t){j(t,{errorType:"xhrError",status:a.status,requestType:l,requestParams:e})},p){console.warn("FN_Ajax multipart is not complete. It may or may not function.");var C=null,b=e.data.file;C=""==b.type?"application/octet-stream":b.type;var D=new FormData(e.data.form);a.send(D)}else if("GET"===m)a.send(null);else{var q=T.length>0?T:null;a.send(q)}return this};"undefined"!=typeof exports?module.exports=t:"function"==typeof define&&define.amd?define("ajax",[],function(){return t}):"function"==typeof define?define("ajax",t):window.ajax=t}(this);